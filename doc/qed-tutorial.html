<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.12">
<meta name="description" content="A tutorial introduction to the Qed editor.">
<meta name="author" content="Robert Pike, Sean Jensen (ed.)">
<title>Programming in Qed: A Tutorial</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:50%;border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article">
<div id="header">
<h1>Programming in Qed: A Tutorial</h1>
<div class="details">
<span id="author" class="author">Robert Pike</span><br>
<span id="author2" class="author">Sean Jensen (ed.)</span><br>
</div>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_introduction">1. Introduction</a></li>
<li><a href="#_buffers">2. Buffers</a></li>
<li><a href="#_special_characters_1">3. Special Characters (1)</a></li>
<li><a href="#_special_characters_2">4. Special Characters (2)</a></li>
<li><a href="#_special_characters_3">5. Special Characters (3)</a></li>
<li><a href="#_registers">6. Registers</a></li>
<li><a href="#_control_structures">7. Control Structures</a></li>
<li><a href="#_calling_the_shell">8. Calling the Shell</a></li>
<li><a href="#_programming_1">9. Programming (1)</a></li>
<li><a href="#_programming_2">10. Programming (2)</a></li>
<li><a href="#_final_comments">11. Final Comments</a></li>
<li><a href="#_editors_notes">12. Editor&#8217;s Notes</a>
<ul class="sectlevel2">
<li><a href="#_remarks">12.1. Remarks</a></li>
<li><a href="#_history">12.2. History</a></li>
<li><a href="#_resources">12.3. Resources</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_introduction">1. Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Qed</strong> is a programmable text editor, intended for use primarily
by programmers.
For the average user, <strong>Qed</strong>'s power will likely be unnecessary,
even troublesome, and its use is discouraged.
For a knowledgeable user who is willing to learn how to use it
properly, however, <strong>Qed</strong> is a powerful tool, both when used
as an editor or as a (rather idiosyncratic and low-level) programming
language.</p>
</div>
<div class="paragraph">
<p><strong>Qed</strong> is very nearly a superset of the University of Toronto
<strong>UNIX</strong> version 6 editor,
<strong>Ed</strong>, which is itself a strict superset of standard <strong>Ed</strong>.
This document assumes considerable familiarity with the standard
editor,
and some acquaintance with the new features of the U. of T. version.
The features of U. of T. <strong>Ed</strong> not found in regular version
6 <strong>Ed</strong> include: the <code>*</code> address separator,
two character error messages (a query followed by a character
which indicates the error, e.g. <code>?s</code> for a failed substitution),
a simple undo <code>u</code> command,
and a join <code>j</code> command of somewhat greater generality
than the *PWB* version.
(The new features used in this tutorial will be briefly explained as
they turn up.)
There is an add-on document for U. of T. <strong>Ed</strong>
which describes the enhancements and modifications, at user level,
made at U. of T.</p>
</div>
<div class="paragraph">
<p>This tutorial is not a complete description of the capabilities of <strong>Qed</strong>.
Rather, it is an attempt to familiarize the programmer with
the general ways in which <strong>Qed</strong> operates,
emphasizing the programming techniques which clarify and simplify its use.
A full description of the commands and features of <strong>Qed</strong>
may be found in the manual section, <code>qed(1)</code>.</p>
</div>
<div class="paragraph">
<p>Before beginning
the discussion of <strong>Qed</strong>,
some warning should be given.
<strong>UNIX</strong> <strong>Ed</strong> is closely based on a version of <strong>Qed</strong>,
running under the <strong>GCOS</strong> operating system,
which was written by Dennis Ritchie and Ken Thompson.
When Dennis Ritchie wrote <strong>Ed</strong>,
he removed many of the features,
including most of the programming capabilities,
but left in most of the text editing power.
Although the <strong>Qed</strong> described here is significantly
more complex and powerful than <strong>Ed</strong>
(and quite unrelated to the <strong>GCOS</strong> <strong>Qed</strong>),
its increase in power is not proportionate to its
increase in complexity.
In short, <strong>Ed</strong> is a very powerful editor, and for general
editing jobs quite sufficient.
<strong>Qed</strong> simplifies some more complicated tasks,
and its multifile capability and programmability make many things possible which
cannot be done in <strong>Ed</strong>,
but to use it well requires a fairly thorough understanding
of its operation, which is fairly intricate.</p>
</div>
<div class="paragraph">
<p><strong>Qed</strong> has several drawbacks that should be admitted early.
<strong>Qed</strong> programs can be difficult to read, even if done
carefully, since it operates at about the level of
a particularly cryptic assembler.
A careless user can easily damage files using
<strong>Qed</strong> incorrectly, but
it is much harder to accidentally cause trouble
with the U. of T. <strong>Qed</strong> than earlier ones,
as the implementors worked very hard at
safeguarding.
The safeguards are strong enough
that occasional users who desire a particular <strong>Qed</strong>
feature for one editing job need not feel in danger of
making a serious mistake.
<strong>Qed</strong>'s power can lead
the user astray;
it has far more power than is needed for most editing jobs.
As an illustrative but rather artificial example,
consider the problem of reversing the lines of a file,
so that the last line appears at the top,
and the first at the bottom,
with the contents of the lines unchanged.
At first, this may seem a problem for <strong>Qed</strong> if it is only
to be done once or twice (if it is to be done often,
we would certainly write a C program!),
but it is very easy to do in <strong>Ed</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>g/^/m0</code></pre>
</div>
</div>
<div class="paragraph">
<p>(For readability&#8217;s sake,
it will be the convention in this tutorial to show user input
aligned with the left margin,
and editor output offset by a tab from the left margin.
In actual practice on the terminal screen,
the editor output is left-aligned on
the left margin, exactly as the input is.)</p>
</div>
<div class="paragraph">
<p>A second, slightly more complicated example is the problem of
placing two columnar files, say files generated by <code>ls</code>,
alongside each other in a buffer.
<strong>Ed</strong> can again do the job quite well:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>$ ed file1
	142
.=
	15
r file2
	153
.=
	30
1ka
16,30 g/^/m'a\
+ka
g/^/ .,+j/       /</code></pre>
</div>
</div>
<div class="paragraph">
<p>How does it work?
After reading in the two files, each of 15 lines,
the first line is marked (<code>1ka</code>).
Then each line in the second file is moved to
the line marked <code>a</code>, setting <code>dot</code> to the moved line,
and the mark is transferred to the next line in the first file
(<code>+ka</code>).
The backslash in the global command line is necessary
to terminate the scan of the target address for the move.
The last command joins each line to the next,
separated by a tab (the white space between the slashes on the
join <code>j</code> command, a facility in U. of T. <strong>Ed</strong>).
Because the global command marks all lines for execution
before running the command list on any of the lines,
after the join the second of each pair of lines has effectively
disappeared from the range of lines of the global,
and each execution of the global command list joins
a line of the first file with its corresponding line in the second.</p>
</div>
<div class="paragraph">
<p>The above example demonstrates several things.
First, <strong>Ed</strong> is considerably more powerful than most of its
users realize.
When first given the problem, most users (including the author!)
assume it is a task best handled by <strong>Qed</strong>.
Second, editor programming often requires the subtle interaction
of many commands: the global join is an excellent example.
Therefore, debugging editor programs can be difficult.
(<strong>Qed</strong> has a
tracing feature which greatly simplifies debugging in some cases.)
Third, editor programs are usually difficult to read and understand.</p>
</div>
<div class="paragraph">
<p>This preamble may sound discouraging, but it is only
promoting realism.
When used well and carefully, <strong>Qed</strong> can be a great time saver,
fun to work with, and sometimes even elegant.
The original <code>troff</code> version of this document was written using <strong>Qed</strong>,
storing sequences like <code>\fBQed\fP</code> in registers
to save typing.</p>
</div>
<div class="paragraph">
<p>Well, if you&#8217;ve read this far,
you must be determined,
so you&#8217;re ready to learn about buffers.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="_buffers">2. Buffers</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Ed</strong> has one buffer: one scratch area in which to keep text.
<strong>Qed</strong> has 56,
labeled by lower case alphabetics <code>a</code> to <code>z</code>,
upper case alphabetics <code>A</code> to <code>Z</code>,
and, for reasons worth ignoring at this point,
the characters <code>{</code>, <code>|</code>, <code>}</code>, and <code>~</code>.
Each buffer has its own associated <code>.</code> (<em>dot</em>), <code>$</code> (<em>dollar</em>), and filename.
The easiest way to see how they work is to
<code>cd</code> to a directory with about ten <code>C</code> source files and type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>$ qed *.c</code></pre>
</div>
</div>
<div class="paragraph">
<p>(we&#8217;ve already accomplished something which is impossible in <strong>Ed</strong>!)
If you were in the <strong>Qed</strong> source directory, you would see
something like</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>	a .82	address.c
	b .121	blkio.c
	c .702	com.c
	d .466	getchar.c
	e .284	getfile.c
	f .119	glob.c
	g .725	main.c
	h .209	misc.c
	i .135	move.c
	j .474	pattern.c
	k .156	putchar.c
	l .38	setaddr.c
	m .128	string.c
	n .418	subs.c
	o .220	utf.c
	p .153	utfio.c
	q .36	utfstr.c</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first column is the buffer name,
the second column is the value of <code>.</code> (<em>dot</em>) in the buffer, which, on
first reading in of a file is set to
the value of <code>$</code> (<em>dollar</em>) in the buffer, that is, the
number of lines, and the last column is the file name local
to that buffer.</p>
</div>
<div class="paragraph">
<p><strong>Qed</strong> is now waiting for a command. Type <code>n</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>n
	a .82	address.c
	b  121	blkio.c
	c  702	com.c
	d  466	getchar.c
	e  284	getfile.c
	f  119	glob.c
	g  725	main.c
	h  209	misc.c
	i  135	move.c
	j  474	pattern.c
	k  156	putchar.c
	l  38	setaddr.c
	m  128	string.c
	n  418	subs.c
	o  220	utf.c
	p  153	utfio.c
	q  36	utfstr.c</code></pre>
</div>
</div>
<div class="paragraph">
<p>and look at the output. It should be nearly identical to the above output <strong>Qed</strong>
printed when it loaded the files on start up, but now there is only one <code>.</code>,
indicating that buffer <code>a</code> is the current buffer.
The <code>n</code> (for <em>names</em>) command is <strong>Qed</strong>'s equivalent of <code>ls -l</code>.</p>
</div>
<div class="paragraph">
<p>Now do an <code>f</code> command. You&#8217;ll see</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>f
	a .82	address.c</code></pre>
</div>
</div>
<div class="paragraph">
<p>In <strong>Qed</strong>, the <code>f</code> command tells you more than just the file name.
Now change something in the file, say substitute out a tab
or delete an empty line, and do another <code>f</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>f
	a'.82	ddress.c</code></pre>
</div>
</div>
<div class="paragraph">
<p>The prime tells you that the contents of the buffer are
known to differ from the named file.
Now try</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>bb f
	b .121	blkio.c</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>bb</code> and <code>f</code> can be placed on the same line,
as <strong>Qed</strong> does not require a newline after most commands.
The <code>bb</code> says <em>change to buffer</em> <code>b</code>.
Buffer <code>b</code> is now the current buffer, as indicated
by the dot.
If you browse around the buffer for a while,
you will see that it is really a world unto itself,
but changing back to buffer <code>a</code> by a <code>ba</code> command
will reset you back to the original file,
with <em>dot</em> still at whatever line it was when you typed <code>bb</code>.</p>
</div>
<div class="paragraph">
<p>Why have multiple buffers?
For one thing, we can copy or move text between buffers.
Go back to buffer <code>a</code> and isolate a subroutine, marking
its beginning with <code>ka</code> and its last line with <code>kb</code>.
Then type</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>'a,'b tz0</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is a regular copy command, but the <code>z</code> after the <code>t</code>
tells <strong>Qed</strong> that the text is to be copied to buffer <code>z</code>.
The <code>0</code> is the usual address, but is interpreted in buffer
<code>z</code> rather than the current buffer.
Of course, if there is no buffer name character after the <code>t</code>
then <strong>Qed</strong> performs the copy command within the current buffer.
Do another <code>n</code>: you will see that you are currently
in buffer <code>z</code>, and <em>dot</em> is set to the last line copied.
The <code>m</code> (<em>move</em>) command behaves similarly.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="_special_characters_1">3. Special Characters (1)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Change to buffer <code>z</code> and clear it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>bz 0,$d</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that line <code>0</code> is a valid address for deletion.
<code>,d</code> also would work here, and neither idiom
generates an error if the buffer is empty.
As well, you could have typed</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>bz Z</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>Z</code> (<em>zero</em>) command unequivocally clears the buffer,
even its remembered file name.
Now do the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>ap g/^[a-zA-Z_].*(/p
	g/^[a-zA-Z_].*(/p</code></pre>
</div>
</div>
<div class="paragraph">
<p>The append commands (<code>a</code>, <code>i</code> and <code>c</code>) all accept a single line
of input typed on the command line, with a space or tab separator
between the command and its input.  As always, a <code>p</code> suffix
causes the command to print its result.
Buffer <code>z</code> now contains a possibly useful command for <strong>Qed</strong>
(do you know what it does?) which we can
call up when desired.</p>
</div>
<div class="paragraph">
<p>Now read some <code>C</code> source into buffer <code>b</code> if there isn&#8217;t already
some there, and try out the buffer like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>bb
\bz
	initio(void)
	getline(addr_t tl, int *lbuf)
	putline(void)
	blkio_r(int b, int *buf)
	blkio_w(int b, int *buf)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The sequence <code>\bz</code> means <em>insert
the contents of buffer</em> <code>z</code> <em>into my input stream here</em>.
The final newline in the buffer
is replaced by the one typed after the <code>z</code>,
so that if you decided later that you wanted to know the line
numbers as well, you could tag a <code>.=</code> command on the end:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>\bz .=
	initio(void)
	43
	getline(addr_t tl, int *lbuf)
	51
	putline(void)
	81
	blkio_r(int b, int *buf)
	108
	blkio_w(int b, int *buf)
	116</code></pre>
</div>
</div>
<div class="paragraph">
<p>Although most <strong>Qed</strong> commands can be arbitrarily grouped on a line,
the global <code>g</code> command, as in <strong>Ed</strong>,
still reads the full line for its command list,
which in this case is <code>p .=</code>.</p>
</div>
<div class="paragraph">
<p>The above example is very important, as it uses a mixture of
buffer input and terminal input to run a command,
an all-pervading concept in <strong>Qed</strong> programming.</p>
</div>
<div class="paragraph">
<p><code>\bz</code> is called a <em>special character</em>, although in some sense
it isn&#8217;t really a character at all, as it gets
completely replaced with the contents of buffer <code>z</code>.
The <code>\bz</code> is interpreted
<strong>whenever input is expected</strong>,
not just when commands are being read.
Try the following examples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>by a
\bz
.
p
	g/^[a-zA-Z_].*(/p
ap \bz
	g/^[a-zA-Z_].*(/p
!echo "\bz"
	g/^[a-zA-Z_].*(/p
	!</code></pre>
</div>
</div>
<div class="paragraph">
<p>The buffer could contain multiple lines, which would be handled as usual.
We could, for example, save in a buffer our example from the
introduction, which merged two columnar files alongside each other,
and invoke it when desired just as we invoked the global search above.
But care must be exercised here, as the newlines in the buffer,
except for the last,
are also placed in the input stream.  If we were to type, with that
multiline buffer in <code>z</code>, the command</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>s/x/\bz/p</code></pre>
</div>
</div>
<div class="paragraph">
<p>mistakenly
expecting that buffer <code>z</code> had just a single line of text,
say a frequently typed word, we would really be saying:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>s/x/1ka
16,30 g/^/m'a\
    +ka
g/^/ .,+j/       //p</code></pre>
</div>
</div>
<div class="paragraph">
<p>This would, of course, cause an immediate error, and since <strong>Qed</strong>
always returns to terminal input when an error occurs,
no damage would be done.
Sometimes, though, such mistakes can cause strange results!</p>
</div>
<div class="paragraph">
<p>If you did try the above command, the error message would be</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>	?bz2.0 ?x</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Qed</strong> gives a traceback on errors.
The elements of the traceback are of the form</p>
</div>
<div class="listingblock">
<div class="title">error code format</div>
<div class="content">
<pre class="highlight"><code>?bXM.N</code></pre>
</div>
</div>
<div class="paragraph">
<p>where <code>X</code> is the buffer name, <code>M</code> the line number, and <code>N</code> the character
number of the character at which the error was recognized.
In the above example, the <em>substitute</em> command found a syntax error (<code>?x</code>)
when it read the newline,
so the error occurred at the beginning (<code>.0</code>) of line <code>2</code> of buffer <code>z</code>.
If input is nested,
the deepest-called buffer is
printed first.</p>
</div>
<div class="paragraph">
<p>It is a good idea to pause here and look carefully over what
has been covered so far, as
the concept of using a buffer to store regular
files or command input interchangeably
is really the heart of <strong>Qed</strong>.
Before reading on,
use <strong>Qed</strong> for a while
to familiarize yourself with the system of buffers,
and try out a few simple buffers
for repetitive editing tasks.</p>
</div>
<div class="paragraph">
<p><strong>Qed</strong> has a fair number of special characters
for various purposes.  In the rest of this section
we will look briefly at some of the simpler ones
to give you some insight into how they behave.
First, enter buffer <code>z</code> again and append:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>bz
a
\Fa
\Fb
.</code></pre>
</div>
</div>
<div class="paragraph">
<p>and then look at what <strong>Qed</strong> has appended to the buffer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>-,p
	address.c
	blkio.c</code></pre>
</div>
</div>
<div class="paragraph">
<p>The special character <code>\Fa</code> means  <em>the file name
for buffer</em> <code>a</code>,
and, like all special characters, is
interpreted whenever input is expected.
The special character <code>\f</code> is a shorthand for
<em>the saved file name in the current buffer</em>.
Try</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>f junk
	z'.2	junk
w
	18
!ls \f
	junk
	!</code></pre>
</div>
</div>
<div class="paragraph">
<p>Idioms such as</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>!cc \f</code></pre>
</div>
</div>
<div class="paragraph">
<p>are very common.
If your file name is long, <code>\f</code> can save much typing.
If the file name is changed, through an <code>f</code> or <code>e</code> command,
the name actually associated with `\f' is only changed when
the new name is completely read in.
Thus, you can type</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>e \f</code></pre>
</div>
</div>
<div class="paragraph">
<p>to reinitialize a buffer, or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>e /sys/src/cmd/\f</code></pre>
</div>
</div>
<div class="paragraph">
<p>to edit the system version of a program.
There is another special character like <code>\f</code>,
but it is more useful for programming.
<code>\B</code> means <em>the current buffer name</em>.
Try</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>!echo \B
	z
	!</code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="_special_characters_2">4. Special Characters (2)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The easiest way to gain familiarity with
the more abstruse characters is to use them
in messages, which are a special case of comments.
A comment starts with a double quote <code>"</code>, and continues
until the first following double quote, or the end
of the line, whichever is first.
The line is ignored by
<strong>Qed</strong>, except that dot is set to the addressed line, if there is one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>4 " This comment sets dot to line 4</code></pre>
</div>
</div>
<div class="paragraph">
<p>Messages are just like comments, except that the first character after
the double quote is another double quote.
If the message ends with a double quote rather than a
newline, no newline is printed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>bx
" hi
"" hi
	 hi
"" hi there "
	 hi there |&lt;- cursor is left on this line
""Current buffer: b\B
	Current buffer: bx</code></pre>
</div>
</div>
<div class="paragraph">
<p>This last example is mildly interesting.
Can we save the command in, say, buffer <code>x</code>
and call it back, from any buffer, when desired?</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>bx Z
ap ""Current buffer: b\B
	""Current buffer: bx
bA \bx
	Current buffer: bx</code></pre>
</div>
</div>
<div class="paragraph">
<p>Oops! In principle, it can be done, since the current buffer is the one
we are working on, not the one being read for input.
But, to put the characters <code>\B</code> in a buffer,
we must delay their interpretation so that
they are not replaced with the buffer name until
read back as command input.
In most systems on <strong>UNIX</strong>, this is done
by typing an extra backslash,
but things are more civilized in <strong>Qed</strong>.
In <strong>Qed</strong>, special characters are
<em>delayed,</em>
not quoted.
Perhaps it&#8217;s simplest just to state the rules:</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">special characters</div>
<div class="ulist">
<ul>
<li>
<p><code><strong>\X</strong></code> is a special character if <code>X</code> is one of
<code><strong>b</strong></code>, <code><strong>B</strong></code>, <code><strong>c</strong></code>, <code><strong>f</strong></code>, <code><strong>F</strong></code>, <code><strong>l</strong></code>, <code><strong>N</strong></code>, <code><strong>p</strong></code>, <code><strong>r</strong></code>, <code><strong>u</strong></code>, <code><strong>U</strong></code>, <code><strong>z</strong></code>, or <code><strong>"</strong></code>,
sometimes (as with <code>\b</code>) followed by a buffer name. It
is interpreted <em>immediately</em>.
(We will see what all these special characters are in due course.)</p>
</li>
<li>
<p><code><strong>\Z</strong></code>, where <code>Z</code> is <strong>not</strong> one of the above,
undergoes no interpretation at all.
In particular, the backslash is not stripped away.</p>
</li>
<li>
<p><code><strong>\c</strong></code> is reduced on scanning to <code>\</code>, but not re-scanned.</p>
</li>
<li>
<p><code><strong>\'X</strong></code> is equivalent to <code>\X</code>, but special characters embedded in <code>\X</code>
are not interpreted.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Things are a little different in regular expressions, but
let&#8217;s ignore them for the moment.
These four rules, simple though they are,
define the interpretation of backslashes in <strong>Qed</strong>.
Note that <code>\\Z</code>, where <code>Z</code> is again <em>not</em> one of the above characters,
remains <code>\\Z</code>, but if <code>Z</code> <em>is</em>
special, say <code>f</code> when the saved file name is <code>junk.c</code>, then
<code>\\f</code> becomes <code>\junk.c</code>.</p>
</div>
<div class="paragraph">
<p>Now we know how to install a <code>\B</code> in our buffer: we delay
its interpretation by putting a <code>c</code>
between the backslash and the <code>B</code>.
(The <code>c</code> is for <em>character</em>,
or (it is rumoured), for <em>Mr. E. S. Cape,</em> inventor of the backslash.)
The <code>\cB</code> will reduce to a literal <code>\B</code> when typed in:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>bx Z
ap ""Current buffer: b\cB
	""Current buffer: b\B

bA \bx
	Current buffer: bA
bB \bx
	Current buffer: bB</code></pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s better! Since <code>\cc</code> will reduce to <code>\c</code>,
the number of <code>c</code>-s present is always just the
number of times the interpretation is to be delayed.</p>
</div>
<div class="paragraph">
<p>To decide how many delays are necessary, here is the list
of input forms that cause characters to be interpreted:</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>terminal input</p>
</li>
<li>
<p>commands or text (such as that saved in buffers) invoked using a special character</p>
</li>
<li>
<p>command lines for the <code><strong>g</strong></code>, <code><strong>v</strong></code>, <code><strong>G</strong></code>, <code><strong>V</strong></code>, or <code><strong>h</strong></code>
commands (<code>g</code> and <code>v</code> are
the same as in <strong>Ed</strong>; we&#8217;ll see the others a little later)</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Note that characters are <em>not</em>
interpreted when buffers are read from or written to files,
or moved or copied with the <code>m</code> or <code>t</code> commands.
Experience is a great help here, so let&#8217;s look at some examples:</p>
</div>
<div class="listingblock">
<div class="title">delay and substitution</div>
<div class="content">
<pre>bx				"switch to buffer x
s/$/\B/			"appends x to current line
s/$/\cB/		"appends \B to current line
s/$/\ccB/		"appends \cB to current line</pre>
</div>
</div>
<div class="paragraph">
<p>but:</p>
</div>
<div class="listingblock">
<div class="title">delay and global</div>
<div class="content">
<pre>g/xxxx/ s/$/\ccB/	"appends \B to all lines matching /xxxx/</pre>
</div>
</div>
<div class="paragraph">
<p>appends <code>\B</code> to all lines with <code>xxxx</code>;
the extra <code>c</code> is because the command is in a global command string.
Let&#8217;s say we want to change all the <code>\n</code>-s to be <code>\n\t</code>.
There are two ways:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>,s/\n/\n\t/
" equivalent to
,s/\cn/\cn\ct/
" or
g/\n/ s/\n/\n\t/</pre>
</div>
</div>
<div class="paragraph">
<p>No delays are necessary because <code>\n</code> and <code>\t</code> are not special characters,
but delaying them once makes no difference:
the <code>\cn</code> just becomes <code>\n</code>, anyway.
(Warning: <code>\n</code> has special meaning in the replacement text of a
substitution in U. of T. <strong>Ed</strong>.)</p>
</div>
<div class="paragraph">
<p>While we&#8217;re dealing with globals, it is a good time to introduce the <code>\N</code>
special character.
It means, simply, a <em>newline</em>,
and is useful primarily because we can delay it in the usual way.
Commands, such as <code>r</code>, which deal with filenames, must often
be followed by a newline, but can be dealt with using <code>\N</code>
in globals.
The <strong>Ed</strong> sequence</p>
</div>
<div class="listingblock">
<div class="content">
<pre>g/xxxx/ r\
.=</pre>
</div>
</div>
<div class="paragraph">
<p>can be put all on one line in <strong>Qed</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>g/xxxx/ r\cN .=</pre>
</div>
</div>
<div class="paragraph">
<p>The newline is delayed.
In original version 6 <strong>Ed</strong>, it is impossible to
globally
substitute a newline into lines,
but it&#8217;s straightforward (by <strong>Qed</strong> standards!) in <strong>Qed</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>g/xxxx/ s//\\cN/p</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>\\cN</code> is a backslash followed by a delayed newline.
The <code>\cN</code> becomes <code>\N</code> when scanned by the global <code>g</code> command,
and then becomes a newline when (re-)read for each <code>s</code> substitution.
In <strong>Qed</strong> (and U. of T. <strong>Ed</strong>) we could also do this
by the functionally slightly different</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>g/xxxx/ s//\\
/p</code></pre>
</div>
</div>
<div class="paragraph">
<p>[Do you see the difference?].</p>
</div>
<div class="paragraph">
<p>Backslashes in general are handled more reasonably in <strong>Qed</strong>
than in other <strong>UNIX</strong> programs.
Because special characters are <em>delayed</em> rather than <em>quoted,</em>
the number of characters required to insert a special character,
with interpretation delayed <code>n</code> times,
is just <code>n+2</code> or <code>n+3</code>,
rather than exponential in <code>n</code>.
A <strong>troff</strong>
line with 31 backslashes, a not-unheard-of
occurrence,
would in <strong>Qed</strong> have a single backslash followed by five <code>c</code> characters.
(And would be much easier to understand, text edit, and debug!)</p>
</div>
<div class="paragraph">
<p>In particular, <strong>Qed</strong> handles backslashes differently from <strong>Ed</strong>.
As mentioned earlier, the <strong>Ed</strong> command</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>s2/"/\\n"/p</code></pre>
</div>
</div>
<div class="paragraph">
<p>is simply</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>s2/"/\n"/p</code></pre>
</div>
</div>
<div class="paragraph">
<p>in <strong>Qed</strong>, because <code>\n</code> is <em>not</em> a special character.
There are, however, characters which are not &#8220;special&#8221;
in the sense
we are using here, but are &#8220;magic&#8221; in
that they have non-literal meaning.
The most obvious are characters such as <code>.</code> and <code>$</code> in regular
expressions, which must be <em>quoted</em> with a backslash to remove
their special meaning and make them literal.
(It becomes clear after using <strong>Qed</strong>, or even <strong>Ed</strong>, for a while that
<em>all</em>
the magic characters in regular expressions and the like
should require a backslash to become
&#8220;magic&#8221;,
rather than literal,
but the current choice is too wired-in to the minds of
most <strong>Ed</strong> users to be changed now.)
Because they are not special characters,
their interpretation need not be delayed:
they only mean something to the <code>s</code> <em>substitute</em> command.
None of the magic characters in the substitution</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>s/\(\.*\)xxx$/\1/</code></pre>
</div>
</div>
<div class="paragraph">
<p>require delaying when typed in or run from a global command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>g/xyz/ s/\(\.*\)xxx$/\1/</code></pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Exercise</div>
<div class="paragraph">
<p>Is the following command the same as the above substitution?</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>s/\c(\c.*\c)xxx$/\c1/</code></pre>
</div>
</div>
<div class="paragraph">
<p>Why or why not?
Is the following the same as the global substitution?</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>g/xyz/ s/\c(\c.*\c)xxx$/\c1/</code></pre>
</div>
</div>
<div class="paragraph">
<p>Try it to test your answers.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Because of these magic characters, two backslashes in a row <code>\\</code>
mean a single backslash <code>\</code> in regular expressions;
otherwise it would be impossible to substitute
in a real backslash before a magic character:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>a abc xyz def
s/xyz/\\&amp;/p
	abc \xyz def
up
	abc xyz def
s/xyz/\\\&amp;/p
	abc \&amp; def</code></pre>
</div>
</div>
<div class="paragraph">
<p>What about sequences like <code>\\B</code>?
Well, <code>\B</code> is not a character at all,
but a <em>special character</em> (sorry for the terminology)
since it is
<strong>immediately</strong>,
at the lowest level
of input, replaced by the current buffer name.
Since <code>\\</code> is <em>not</em> a special character,
and has non-literal meaning only when found between
regular expression delimiters,
the substitute command itself never sees the second backslash.
All interpretation of special characters is done
<em>before</em> the substitute command sees them.
If the current buffer is buffer <code>a</code>, then</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>s/\\B/x/</code></pre>
</div>
</div>
<div class="paragraph">
<p>does exactly the same thing as</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>s/\a/x/</code></pre>
</div>
</div>
<div class="paragraph">
<p>Also, because <strong>Qed</strong> next converts <code>\\</code> to <code>\</code> in
regular expressions,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>s2/"/\\n"/p</code></pre>
</div>
</div>
<div class="paragraph">
<p>is the same as</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>s2/"/\n"/p</code></pre>
</div>
</div>
<div class="paragraph">
<p>since <code>\n</code> is not a special character.</p>
</div>
<div class="paragraph">
<p><strong>Qed</strong> saves the last used regular expression and replacement text
used in an <code>s</code> or <code>j</code> command,
so that they can be called back using <code>\p</code> (for <em>pattern</em>)
and <code>\r</code> (for <em>righthand side</em>).
<code>\p</code> is handy when you want to change the saved pattern.
If, for example, you start searching for <code>proc()</code>
and want the declaration, but find there are very many usages of <code>proc()</code>,
it is simple to find an occurrence of <code>proc()</code> at the beginning
of a line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>/proc()/
	    x=proc();
//
	    x=proc()*2;
/^\p/
	proc(){</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>\p</code> is of somewhat limited usefulness, as the null regular expression <code>//</code>
is essentially the same as <code>/\p/</code>;
but <code>\r</code> provides a new convenience.
Browsing through text doing repetitive substitution
is simplified considerably by using <code>\r</code> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>s/apples/mangos and pears/p
	I ain't got no mangos and pears
//
	your mother's apples smelled like they were
s//\r/p
	your mother's mangos and pears smelled like they were</code></pre>
</div>
</div>
<div class="paragraph">
<p>There is a danger with <code>\p</code> and <code>\r</code> :
if they contain delayed special characters,
each usage of <code>\p</code> or <code>\r</code> removes one delay.
If the current file name is <code>wylbur.ms</code>,
it may be difficult to deal with <code>troff</code> font changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>p
	editors such as Wylbur are so
s/Wylbur/\cfBWylbur\cfP/p
	editors such as \fBWylbur\fP are so
//
	Wylbur is also no good for
s//\r/p
	wylbur.msBWylburwylbur.msP is also no good for
" Oops</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is the sort of trouble which the <code>\'</code> special character can
circumvent.
<code>\'r</code> means the usual <code>\r</code>, but with special characters inside
<em>uninterpreted</em>.
If we had used it above, things would have worked properly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>p
	editors such as Wylbur are so
s/Wylbur/\cfBWylbur\cfP/p
	editors such as \fBWylbur\fP are so
//
	Wylbur is also no good for
s//\'r/p
	\fBWylbur\fP is also no good for
" Much better</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>\r</code> is also handy for fixing a certain class of mistakes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>p
	textp=get(a-&gt;text.fdes);
s/text/tbuf/p
	tbufp=get(a-&gt;text.fdes);
" Oops again
	textp=get(a-&gt;tbuf.fdes);
" Got it!</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <strong>Qed</strong> idiom <code>us2//\'r/p</code>
undoes (<code>u</code>) what you just did wrong, then substitutes (<code>s</code>) again (<code>//</code>) on the <em>second</em> (<code>2</code>) match in the line.</p>
</div>
<div class="paragraph">
<p>Now, as an exercise, use <strong>Qed</strong>
for a while until you feel comfortable with
the use of backslashes.  If you find them
confusing, work with
<strong>Qed</strong>, doing fancy things if you feel up to it,
until the confusion disappears.
What follows will be much stranger &#8230;&#8203;</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="_special_characters_3">5. Special Characters (3)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that we&#8217;ve established the ground rules,
we can begin to use some of the fancier stuff in <strong>Qed</strong>.</p>
</div>
<div class="paragraph">
<p>The special character <code>\l</code> (for <em>line</em>) returns a line of text from
standard input,
usually the user at the terminal. In other words,
if, say, input is coming from a buffer, then the input will be temporarily
redirected to come from the terminal.
The terminating newline is stripped away.
Since it is interpreted immediately (being a special character),
<code>\l</code> is rarely of value
<em>except</em> when delayed. Nevertheless, let&#8217;s look at how it behaves
in immediate mode:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>""\lMessage\N
	Message
""\lMessage

	Message
""\lMessage
s of words
	Messages of words</code></pre>
</div>
</div>
<div class="paragraph">
<p>The extra newline, whether provided by the <code>\N</code>, or by a typed second
carriage return, is necessary because the <code>\l</code> strips its
terminating newline away, but the comment (<code>""</code>) command is looking
for a newline itself in order to terminate.</p>
</div>
<div class="paragraph">
<p>[Some questions to consider:
If <code>\bx</code> is used instead of <code>\l</code>,
the second newline is not required.  Why?
In the last example above,
which characters are returned by <code>\l</code>?
What is the origin of the others, if any?
What would the above examples do if
the comments were terminated with a double quote?]</p>
</div>
<div class="paragraph">
<p>Well, <code>\l</code> is clearly of little use if not delayed,
but it <em>is</em> important to understand how it behaves.</p>
</div>
<div class="paragraph">
<p>An early version of U. of T. <strong>Qed</strong> had only lower case buffer names,
and when the names <code>{</code> through <code>~</code> were added it was necessary
to go through the manual changing some of the instances of <code>`z'</code> into
<code>`~'</code>, but not all of them.
The following single line made the job very simple:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>g/`z'/ p ""replacement:" s//`\cl'/p</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each line (<code>g</code>) with a <code>`z'</code> (<code>/`z'/</code>) is printed (<code>p</code>),
the user is prompted for the
replacement (<code>""replacement:"</code>), and the response (<code>\l</code>)&#8201;&#8212;&#8201;either a <code>z</code> or a <code>~</code> in our case&#8201;&#8212;&#8201;is substituted (<code>s//`\cl'/</code>).
The single delay ensures that <code>g</code> places a literal <code>\l</code>
in the substitution string,
which is then interpreted when each call to the substitute command
builds its replacement (<em>right-hand side</em>) text.
This sort of operation can also be performed using an <code>x</code> command
driven by a global, but <strong>Qed</strong> can be programmed
to do most of the work.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s another example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>bz ,d
ap ""Comment:\cl" s|$|	/* \cl */|p
	""Comment:\l" s|$|	/* \l */|p</code></pre>
</div>
</div>
<div class="paragraph">
<p>On any line which invokes this buffer with a <code>\bz</code>, the first <code>\l</code>
in the comment will &#8220;eat&#8221; any input remaining
on the line after the <code>\bz</code> (and inserts it into the comment command (<code>""</code>)
where the first <code>\l</code> appears, namely after the <code>:</code>. Perhaps not very useful!).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>ba a	c.code;
\bz
	Comment:stylish				<b class="conum">(1)</b>
		c.code;	/* stylish */

a	more.code;
\bz foobar
	Comment:foobarstylish		<b class="conum">(2)</b>
		more.code;	/* stylish */</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Prompt is <code>Comment:</code>, user types <code>stylish</code></p>
</li>
<li>
<p>Prompt is <code>Comment:foobar</code> (<em>sic!</em>), user types <code>stylish</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>(Also, of course, if what the user typed at the prompt contains the character
<code>|</code>, problems will occur.)</p>
</div>
<div class="paragraph">
<p>Now, if we intend to be able to type our C comment text
on the same line as the invocation of the buffer,
as if passing it as an argument,
we want neither the <code>Comment:</code> message nor
the extra <code>\l</code> which clears the input line. Assuming buffer <code>z</code> still contains
our commenting program, let&#8217;s edit out the <code>Comment:\l</code> prompt, and
try it again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>bz s/".*" //p
	s|$|        /* \l */|p
ba a	yetmore.code;
\bzstylish
		yetmore.code;	      /* stylish */</code></pre>
</div>
</div>
<div class="paragraph">
<p>This latter form is likely more useful,
as it can be called from a global
(the previous version could, but required the user
to type extra newlines).
For example, to comment all occurrences of a variable named <code>var</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>g/\{var\}/ p \cbz</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each line is printed, and the user&#8217;s response is appended as a C
comment.
No extra <code>\l</code> is needed at the end to clear the input line
as the <code>g</code> already reads the line up to and including the terminal newline.
Thus the single <code>\l</code> in the <code>s</code> command in buffer <code>z</code>
returns the next line typed in.
Note that the <code>\bz</code> command is delayed so that it is interpreted
for each selected line.</p>
</div>
<div class="paragraph">
<p>We could alternatively have set up our <code>z</code> buffer so that the <code>\l</code> itself
was delayed, using <code>\cl</code> instead.
The buffer could then be invoked (in a global command) as <code>\bz</code>,
without the delay.</p>
</div>
<div class="paragraph">
<p>In effect, then, the <code>c</code> in the original buffer call <code>\cbz</code> above acts to delay
the <code>\l</code>.  If the buffer had only literal text,
no delay would be necessary.
Our choice of where to put the delay
was made by wanting the buffer to be invocable directly from
the keyboard.</p>
</div>
<div class="paragraph">
<p>Just for the record,
note that we can achieve the effect of <code>\cb</code> above by
typing <code>\'b</code>, although the manner in which it works
is quite different.</p>
</div>
<div class="paragraph">
<p>Although these examples are somewhat low-key,
they do begin to show how the parts of <strong>Qed</strong> fit together.
Later, we will see how the <code>\l</code> can be used
to control execution of commands.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="_registers">6. Registers</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Qed</strong> has 56 registers, with the same names as the buffers:
<code>a</code> to <code>z</code>, <code>A</code> to <code>Z</code>, <code>{</code>, <code>|</code>, <code>}</code>, and <code>~</code>.
Buffers and registers are otherwise unrelated.
The registers are used to store simple text and short
command sequences.
In fact, most of the command buffers we have created
so far would be better suited to storage in registers;
buffers are generally used for storage of file text proper
and multiline command sequences.
The two main advantages of using registers to store text
are:
they can be set and manipulated without leaving the current buffer,
and they do not appear in the output from <code>n</code> commands,
which is significant because a user may typically have
twenty or more defined registers.</p>
</div>
<div class="paragraph">
<p>Registers are manipulated with the <code>z</code> (for <em>zdring</em>!) command.
The character after the <code>z</code> is the name of the register being
operated on,
and the next character is an <em>operation code</em>.
The most straightforward operations are assignment (<code>:</code>) and printing (<code>p</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>za:procrastination
zap
	procrastination</code></pre>
</div>
</div>
<div class="paragraph">
<p>The string being assigned to the register is terminated by a newline.
If a newline is to be embedded in the register, <code>\N</code> provides
the cleanest mechanism:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>za:line1\cNline2
zap
	line1\Nline2
a
\za
.
-,p
	line1
	line2</code></pre>
</div>
</div>
<div class="paragraph">
<p>As a cconvenience, <strong>Qed</strong> also allows multi-line assignment
to a register by escaping a literal newline with <code>\</code> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>za:line1\
line2
zap
	line1
	line2
a
\za
.
-,p
	line1
	line2</code></pre>
</div>
</div>
<div class="paragraph">
<p>Registers are invoked in the obvious way: <code>\za</code> inserts the
contents of register <code>a</code> into the input stream.
Note in the above example that the append (<code>a</code>) could not be done
on one line,
as the embedded newline in the register would cause the
first line (<code>line1</code>) of the register to be appended,
and the second (<code>line2</code>) to be interpreted as (ill-formed) command input:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>zap
	line1\Nline2
a \za
	line1
	?za10 ?x</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is another example of embedded newlines causing trouble:
be careful!</p>
</div>
<div class="paragraph">
<p>There are many <em>operation characters</em> for registers;
they are listed in full in the <code>qed(1)</code> manual section.
For example, we can perform a substitute operation on the
contents of the register with <code>zas/xxx/yyy/</code> (the same syntax
as for the substitute command <code>s</code>);
increment and decrement the Unicode codepoint values of the characters
in the register with <code>za+N</code> and <code>za-N</code>, where <code>N</code> is an integer;
and do subzdring (!) operations with the <em>take</em> and <em>drop</em> functions
<code>za)N</code> and <code>za(N</code>.
One particularly handy form is</p>
</div>
<div class="listingblock">
<div class="title">register set to match</div>
<div class="content">
<pre class="highlight"><code>za/regular expression/</code></pre>
</div>
</div>
<div class="paragraph">
<p>which saves in register <code>a</code> the string in the current line
which matches the regular expression.
There are several other register operations we will introduce
when required.</p>
</div>
<div class="paragraph">
<p>These operations are quite straightforward; we will see them
all used when we start to program <strong>Qed</strong>.</p>
</div>
<div class="paragraph">
<p>Registers can also be manipulated numerically. This is indicated
by the <code>#</code> (for <em>number</em>) operation: <code>za#...</code> . The text following
the <code>#</code> is then interpreted specially. Decimal numbers (integers)
stand for themselves, and numeric assignment to the register is <code>:</code>. So:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>za#:42
zap
	42
za#:-42
zap
	-42</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this numeric-register context, the letters <code>a</code>, <code>r</code>,
<code>n</code>, <code>N</code>, <code>p</code> and <code>P</code> have special meanings. For example <code>p</code> means
<em>print the current value of the register</em>. We will look at <code>a</code> and <code>r</code>
shortly.
The rest are described in the <code>qed(1)</code> manual. We can chain numeric
operations together (without spaces):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>za#:42p
	42
za#:-42p:99p
	-42
	99
zap
	99</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the last example, -42 is assigned (<code>:-42</code>) to <code>a</code>, then the current value
of <code>a</code> is printed (<code>p</code>), then 99 is assigned (<code>:99</code>) to <code>a</code>, and the
current value of <code>a</code> is again printed. Register <code>a</code>
contains 99 at the end of the numerical context.</p>
</div>
<div class="paragraph">
<p>In this numeric context, the value of the register can be updated by
one of the arithmetic operations <code>+</code>, <code>-</code>, <code>*</code>, <code>/</code>, and <code>%</code>, which
have their familiar C language meanings:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>za#:1
za#+1p
	2
za#*2p
	4
za#*2+1p
	9</code></pre>
</div>
</div>
<div class="paragraph">
<p>Numeric-register context ends at the first character which is invalid
in a numeric-register context, or the first newline, whichever comes first.
When numeric-register context ends, the entire <code>z&#8230;&#8203;</code> register command
ends, and <strong>Qed</strong> will start processing any remaining characters on the
line as regular <strong>Qed</strong> commands. This can have some bizarre side-effects:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>ba Z
a foo.bar;
za#:99p
	99
za#:99 p
	foo.bar;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In <code>za#:99 p</code>, the space (after the <code>99</code>) is <em>not</em> a valid character in
numeric-register context, so it terminates the <code>za#:99</code> command. The
remainder of the line (` p`) is then interpreted as a regular <strong>Qed</strong>
command (namely, <em>print the current line</em>), which it duly does.</p>
</div>
<div class="paragraph">
<p>It is an error (<code>?#</code>) to try to perform numeric operations on a register
which does not contain a (possibly negative) decimal integer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>za:44moose
za#*2
	?#</code></pre>
</div>
</div>
<div class="paragraph">
<p>The main difference between <code>zap</code> and <code>za#p</code> is semantic.
In <code>zap</code>, the contents of register <code>a</code> are interpreted as
a string, and the (string-)register operation <code>p</code> prints the
string held in <code>a</code>. In <code>za#p</code>, the contents of register <code>a</code>
are interpreted in numeric context, and the numeric-register
operation <code>p</code> prints the (numeric) value in <code>a</code>. In practice,
the outcome of <code>zap</code> and <code>za#p</code> is the same if <code>a</code> contains a decimal integer.</p>
</div>
<div class="paragraph">
<p>Perhaps the most important use of numeric-register operations
is in addressing.
The numeric-operation character <code>a</code> causes the register to receive
the line number of the address of the <code>z</code> command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>$za#a</code></pre>
</div>
</div>
<div class="paragraph">
<p>assigns to register <code>a</code> the line number of the last line (<code>$</code>), <em>i.e.</em> the
number of lines in the current buffer; and</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>/xxxx/za#a</code></pre>
</div>
</div>
<div class="paragraph">
<p>saves in <code>za</code> the address of the first forward occurrence of <code>xxxx</code>.</p>
</div>
<div class="paragraph">
<p>The <code>r</code> operation character (for <em>range</em>)
stores the first given address in the named register,
and the second address in the register whose name is
lexically one greater:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>1,$ za#r
,za#r</code></pre>
</div>
</div>
<div class="paragraph">
<p>Both put <code>1</code> in register <code>a</code> and the value of <code>$</code> in register <code>b</code>.
Neither <code>a</code> nor <code>r</code>
changes the value of <em>dot</em>.</p>
</div>
<div class="paragraph">
<p>These operations are usually used to pass addresses to an execution buffer:
if the first line of a buffer is</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>za#r</code></pre>
</div>
</div>
<div class="paragraph">
<p>then if the buffer is invoked as, say,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>-5,.\bz</code></pre>
</div>
</div>
<div class="paragraph">
<p>then registers <code>a</code> and <code>b</code>
contain the addresses of the first and last lines of
the range to be operated on by the buffer.</p>
</div>
<div class="paragraph">
<p>Numerical operations are also frequently useful in text editing,
such as when generating defined constants for a table:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>a
read
write
open
close
creat
.
" capitalize
?read?,.s/.*/^/p
	CREAT
za#:0
?READ?,.g/^/s/.*/#define &amp;	\cza/p za#+1
	#define READ	0
	#define WRITE	1
	#define OPEN	2
	#define CLOSE	3
	#define CREAT	4</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>^</code> (caret) character in the right hand side of a substitute
behaves like <code>&amp;</code>, but flips the case of ASCII alphabetics in the matched string.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="_control_structures">7. Control Structures</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The most commonly used control structure in <strong>Qed</strong> is certainly
the global command, <code>g</code>, which is remarkably powerful and versatile,
as the previous example demonstrates.
The ability to place several commands on a line,
and the simplicity of <code>\N</code>, make globals even easier to use in <strong>Qed</strong>
than in <strong>Ed</strong>.</p>
</div>
<div class="paragraph">
<p>Along with the concept of line-by-line execution goes that of
buffer-by-buffer execution, which is provided in <strong>Qed</strong>
by the <em>globuf</em> commands <code>G</code> and <code>V</code>.
They are quite simple to use:
their format is identical to the regular globals <code>g</code> and <code>v</code>,
but the regular expression is used to match the
output which would be produced by an <code>f</code> command in each buffer.
Only buffers which contain text or have a remembered file name
are tested for a match.
If a buffer matches the regular expression, the command list
is executed in that buffer.
For example,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>G/.'.*	./w</code></pre>
</div>
</div>
<div class="paragraph">
<p>writes out (<code>w</code>) all buffers which have been modified since
last written. That is, all buffers which the <code>f</code> command
reports with a prime (<code>'</code>) after the buffer name.
The white space in the above example is a tab,
which is the actual delimiter used by the <code>f</code> (and <code>n</code>) commands
between the number of lines in the buffer and the file name.
Here&#8217;s a fancier example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>G/./ g/thing/ ""\cB \cf: " p</code></pre>
</div>
</div>
<div class="paragraph">
<p>It takes all non-null buffers (<code>G/./</code>), and
for each one it looks for occurences of <code>thing</code> (<code>g/thing/</code>). Whenever
it finds one, it
prints out (<code>""&#8230;&#8203;"</code>) the buffer (<code>\B</code>), the file name (<code>\f</code>), and
line (<code>p</code>). It&#8217;s a bit like a super-grep, or <em>Gregrep</em>.</p>
</div>
<div class="paragraph">
<p><strong>Qed</strong> has a <em>loop</em> control structure, the <code>h</code> command (for <em>h-until</em>!).
<code>h</code>, like <code>g</code>, takes a line of commands and executes it repeatedly.
It has four forms:</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">loop</div>
<div class="ulist">
<ul>
<li>
<p><code><strong>hN</strong></code>        executes the line N times</p>
</li>
<li>
<p><code><strong>ht</strong></code>        executes the line until the <em>truth flag</em> is true</p>
</li>
<li>
<p><code><strong>hf</strong></code>        executes the line until the <em>truth flag</em> is false</p>
</li>
<li>
<p><code><strong>ha</strong></code>        (for <em>always</em>) executes the line forever, or until an error</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Although the loop is an <em>until</em>,</p>
</div>
<div class="listingblock">
<div class="title">no-op</div>
<div class="content">
<pre class="highlight"><code>h0 p</code></pre>
</div>
</div>
<div class="paragraph">
<p>is guaranteed to execute zero times. An infinite loop
can be halted by sending <span class="keyseq"><kbd>Ctrl</kbd>+<kbd>C</kbd></span> from the terminal.</p>
</div>
<div class="paragraph">
<p>The <em>truth flag</em> is set by substitutions, and comparison operations
in registers.
When a register is compared to some value, the truth flag is
set according to the success of the comparison.
When a substitution is made, the truth flag is set
if a substitution was performed.
As a simple example, say you have prepared a letter to be sent to
someone, using <strong>Qed</strong>, only to find that the erase character
is a backspace, not <code>#</code> as you had been using.
To fix the problem,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>g/^/ hf s/.#//</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that <em>huntil</em>-s can be run inside globals,
and, in fact, can be nested arbitrarily deep.
Globals can also be run from <em>huntils</em>;
the only restriction is that globals cannot be called
from globals, as <strong>Qed</strong> can only mark a line for a global once.
Similarly, <em>globufs</em> cannot be called from <em>globufs</em>.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Exercise</div>
<div class="paragraph">
<p>Change the example where <code>z</code>-s were replaced by <code>~</code>-s
so that it works properly when there is more than one <code>z</code> on a line.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>As in globals, <em>huntil</em>s stop the scan of the command sequence
at the first newline.
To build an alphabet in register <code>A</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>za:a
zA:
h26 zAs/$/\cza/ za+1
zAp
	abcdefghijklmnopqrstuvwxyz</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that <strong>Qed</strong> code is not always easy to read!
If you happen to know that the character which precedes <code>a</code> in Unicode
is back-quote (<code>`</code>), you could also build the alphabet with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>za:`
zA:
h26 za+1 zAs/$/\cza/
zAp
	abcdefghijklmnopqrstuvwxyz</code></pre>
</div>
</div>
<div class="paragraph">
<p>And now, register <code>a</code> could also be used in <em>auto-increment mode</em> to simplify
things further:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>za:`
zA:
h26 zAs/$/\cz+a/
zAp
	abcdefghijklmnopqrstuvwxyz</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>+</code> between the special character <code>\z</code> and the <code>a</code>
in the register call causes the
values of the Unicode codepoints of the character(s) in <code>a</code> to be incremented
before being placed in the input stream:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>za:moose
""\z+a
	npptf</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Auto-decrements</em> are also possible (<code>\z-a</code>) as are numerical
increments and decrements (<code>\z#+a</code> and <code>\z#-a</code>).
Only auto-increments of +1 and auto-decrements of -1 are possible.</p>
</div>
<div class="paragraph">
<p>As a less frivolous example (one that was used in writing an earlier
version of this
tutorial), a <em>huntil</em> makes it simple to convert, say, the <em>troff</em>
command <code>.ul 5</code> to five <code>.ul</code>-s, one after each affected line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>g/^\.ul [0-9]+/ zn/[0-9]+/ zn#-1 s/ [0-9]+// h\czn +a .ul</code></pre>
</div>
</div>
<div class="paragraph">
<p>It looks horrible, but it works, and can save much trouble
if there are (as in the tutorial) twenty or more places
where the fix needs to be made.
(The <code>+</code> character in regular expressions is like <code>*</code>,
but guarantees at least one match.)</p>
</div>
<div class="paragraph">
<p>Of course, until familiarity with <strong>Qed</strong> is developed,
the mental effort required to write a line like this and have
it work is probably considerably greater than the
physical effort required to type in the changes individually.
Even for beginning users, though, saving the complicated
patterns, and commands such as <code>ap .ul</code> in registers
would make the job much more pleasant.</p>
</div>
<div class="paragraph">
<p>Again, care must be taken when invoking registers or buffers in
<em>huntil</em>-s:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>h20 \bz
" or "
h20 \cbz</code></pre>
</div>
</div>
<div class="paragraph">
<p>will likely not do what is expected if buffer <code>z</code> contains
more than one line.</p>
</div>
<div class="paragraph">
<p>The other major new control structure in <strong>Qed</strong> is the <code>y</code> command
(for <em>yump;</em>
think of <em>jump</em> pronounced with a Swedish accent).
The syntax is:</p>
</div>
<div class="listingblock">
<div class="title">jump</div>
<div class="content">
<pre class="highlight"><code>y[t|f][N|o|'label|`label]</code></pre>
</div>
</div>
<div class="paragraph">
<p>which translates as follows:
If the <code>t</code> or <code>f</code> is present,
jump only if it matches the <em>truth flag;</em>
otherwise jump unconditionally.
The <code>N</code>, if present, is a number, and is interpreted
as a line number in the current
executing buffer, which becomes the next line read for commands.
An <code>o</code> (for <em>out</em>) causes the current input source,
such as a global command string or buffer, to be terminated.
If the input source is a buffer, the effect is to return from the buffer;
if a global, the execution of the global (or <em>huntil</em>) is stopped.
For example,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>za#:1
h50 za#+1 za#&gt;20 yto
zap
	21</code></pre>
</div>
</div>
<div class="paragraph">
<p>executes 21 times, leaving register <code>a</code> set to 21.</p>
</div>
<div class="paragraph">
<p>The forms</p>
</div>
<div class="listingblock">
<div class="title">conditional jump forward to label</div>
<div class="content">
<pre class="highlight"><code>y[t|f]'label</code></pre>
</div>
</div>
<div class="paragraph">
<p>and</p>
</div>
<div class="listingblock">
<div class="title">conditional jump backward to label</div>
<div class="content">
<pre class="highlight"><code>y[t|f]`label</code></pre>
</div>
</div>
<div class="paragraph">
<p>are similar to <code>y[t|f]N</code>, but the line to which control is transferred
is the first line found which begins with the comment <code>"label</code>,
searching forward in the buffer in the case of <code>y[t|f]'label</code>; or
backward in the buffer in the case of <code>y[t|f]`label</code> (where the
operation character is a <em>back-tick</em>).
Initial blanks and tabs on the line before the comment character <code>"</code>
are ignored, and the scan of the
label stops at the first blank, tab, newline or double quote.
If the first character after the double quote is a space, tab,
newline or double quote, the label is null and can never be matched.
If no matching label is found in the executing buffer,
execution resumes at the first
character after the label in the <em>yump</em> command.
Note that the label must be matched exactly;
it is not interpreted as a regular expression.</p>
</div>
<div class="paragraph">
<p>There are a few non-trivial small examples
which illustrate the use of <em>yumps,</em>
but they will be used later on in the tutorial.
For the moment, a remark on style:
clearly, with only a <em>goto,</em> flow of control in <strong>Qed</strong>
can become messy if care is not taken.
It is recommended that <em>yump</em>-s only be used in
easily identifiable forms such as <em>if &#8230;&#8203; then &#8230;&#8203; else &#8230;&#8203;</em>:</p>
</div>
<div class="listingblock">
<div class="title">if &lt;condition&gt; then &#8230;&#8203; else &#8230;&#8203;</div>
<div class="content">
<pre class="highlight"><code>&lt;condition&gt; yf'else
    ...
y'fi
"else
    ...
"fi</code></pre>
</div>
</div>
<div class="paragraph">
<p>and, <em>do &#8230;&#8203; until &#8230;&#8203;</em></p>
</div>
<div class="listingblock">
<div class="title">do &#8230;&#8203; until &lt;condition&gt;</div>
<div class="content">
<pre class="highlight"><code>"do
    ...
    &lt;condition&gt; yf`do
"od</code></pre>
</div>
</div>
<div class="paragraph">
<p>or, <em>while &#8230;&#8203; do &#8230;&#8203;</em></p>
</div>
<div class="listingblock">
<div class="title">while &lt;condition&gt; do &#8230;&#8203;</div>
<div class="content">
<pre class="highlight"><code>"{
    &lt;condition&gt; yf'}
    ...
    y`{
"}</code></pre>
</div>
</div>
<div class="paragraph">
<p>One particularly useful form of labeled <em>yump</em>-s is a <em>switch</em> statement
based on a line of input from the user.  This mechanism makes
command interpretation very simple.
It is essentially a fancy switch statement:</p>
</div>
<div class="listingblock">
<div class="title">switch</div>
<div class="content">
<pre class="highlight"><code>y'X\l
"default:
    ...
    yo
"Xcase1
    ...
    yo
"Xcase2
    ...
    yo
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>One other form of <em>yump</em> exists; it is intended primarily to
skip the rest of a <em>global</em> or <em>huntil</em> command sequence, without
stopping the execution completely.
Its form is simply <code>yt</code>, or <code>yf</code>.
When invoked, it jumps over the current input source
up to and including the next newline.
It can also be used as a shorthand in buffers,
but such usage is discouraged.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="_calling_the_shell">8. Calling the Shell</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Qed</strong> has three methods of calling the Shell aside from the <code>!</code> (<em>bang</em>)
command: <em>crunch</em> (<code>&lt;</code>), <em>zap</em> (<code>&gt;</code>), and <em>pipe</em> (<code>|</code>). All of these
commands cause the <strong>UNIX</strong> commandline they last invoked to be stored in
register <code>U</code>. This commandline can be recalled by doubling the command
character, as if the command <code>\'zU</code> was issued:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>!echo fun
	fun
	!
zUp
	echo fun
!!
	fun
	!</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can even extend the saved commandline:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>!! | wc -c
	4
	!
zUp
	echo fun | wc -c</code></pre>
</div>
</div>
<div class="paragraph">
<p>And edit it, just like any other register:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>zUs/fun/funny/
!!
	6
	!
zUp
	echo funny | wc -c</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Crunch</em> (<code>&lt;</code>) takes the standard output from the Shell command
and reads it into the current buffer,
as if the output from the
Shell command had been redirected to a temporary file,
which is then read in with an <code>r</code> command.
Like the <code>r</code> command, <code>&lt;</code> takes an optional address which
specifies the line (defaulting to <code>$</code>) at which
the text is to be read in.
(As above, the <strong>UNIX</strong>  command last executed
can be reinvoked, as a <em>crunch</em>, with <code>&lt;&lt;</code>.)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>&lt; ls
	!</code></pre>
</div>
</div>
<div class="paragraph">
<p>appends a list of the files in the current directory to the end
of the buffer.</p>
</div>
<div class="paragraph">
<p>One very common usage of the crunch command is to
create a to-do list, by a command such as</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>&lt; grep "FIX ME!" *.c
	!</code></pre>
</div>
</div>
<div class="paragraph">
<p>or using a buffer as a sort of checklist by
capturing diagnostic output from a compiler, say:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>bz Z
&lt; cc -c *.c | tee /dev/tty
	... diagnostic messages ...
	!</code></pre>
</div>
</div>
<div class="paragraph">
<p>saves the listing of the compile errors so you can let <code>cc</code>
run through everything before fixing typing mistakes, etc.</p>
</div>
<div class="paragraph">
<p><em>Zap</em> (<code>&gt;</code>) is to <em>crunch</em> as <code>w</code> is to <code>r</code>: it writes out the contents
of the addressed lines (defaulting to the entire current buffer)
as standard input to the Shell command.
It is can be used to send e-mail.
The e-mail can be prepared in a buffer, edited as desired,
and then sent easily by</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>&gt; mail joe
	!</code></pre>
</div>
</div>
<div class="paragraph">
<p>or even</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>&gt; nroff | mail joe
	!</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Zap</em> and <em>crunch</em> work nicely together.
We can perform an interactive file-delete function,
(like the ancient <code>dsw</code> command) using <em>crunch</em>
to read the files in,
modifying the list as appropriate,
and sending it out to (another ancient command) <code>args</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>&lt; ls
	!
... editing commands ...
&gt; args rm
	!</code></pre>
</div>
</div>
<div class="paragraph">
<p>(<code>args</code> was a command that took each line on its standard input
and maked it an argument to the command,
which was then <code>exec</code>-ed in the normal manner.)</p>
</div>
<div class="paragraph">
<p>The following commands can initiate the construction of
a dependency-list file for <code>make</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>&lt;grep "#include" *.c
	!
,s/:#include[ 	]"/ 	//
,s/"$//p
	utfio.c	qed.h</code></pre>
</div>
</div>
<div class="paragraph">
<p>At U. of T., the Shell takes a <code>-e</code> option which tells it to
echo on the diagnostic output
the commands it is executing, which works nicely with <em>zap:</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>a
command1
command2
command3
.
&gt; sh -e
	% command1
	% command2
	% command3
	!</code></pre>
</div>
</div>
<div class="paragraph">
<p>In short, the <em>crunch</em> and <em>zap</em> commands are used very frequently.</p>
</div>
<div class="paragraph">
<p>The <em>pipe</em> command (<code>|</code>) is very similar to <em>crunch</em>. Whereas
<em>crunch</em> takes a single address, and <em>inserts</em> the standard output
of the commandline at that address,
<em>pipe</em> takes an address range, and it <em>replaces</em>
the addressed range with the standard output of its commandline.
The default address range for <em>pipe</em> is the entire buffer (<code>1,$</code>),
so the command <code>&lt; ls</code> will append a directory listing to the current
buffer, but the command <code>| ls</code> will <em>replace</em> the contents of the
buffer with the directory listing.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="_programming_1">9. Programming (1)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that we&#8217;ve seen all the primitives,
we can begin using buffers and registers to build
more sophisticated commands.
The first step is to
assemble a few useful command sequences in
registers.
Harking back to our function-declaration-finding
buffer in Section 3, define register <code>f</code> (for <em>function</em>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>zf:?^[a-zA-Z_].*(?
zfp
	?^[a-zA-Z_].*(?</code></pre>
</div>
</div>
<div class="paragraph">
<p>As a <em>global</em> search, the regular expression <code>/^[a-zA-Z_].*(/</code> found
all function declarations, provided, of course,
that the usual paragraphing style is used.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Exercise</div>
<div class="paragraph">
<p>Write another definition to perform this function
which uses the <em>beginning of identifier</em> (<code>\{</code>) metacharacter.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Now, with the regular expression enclosed in <code>?&#8230;&#8203;?</code>,
register <code>f</code>
finds the first <em>previous</em>
function declaration.
This seems like an odd concept at first, but works well.
For example,
to see which function&#8217;s source is being browsed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>\zf
	function(x)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or, to find the declaration of a local variable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>p
	    variable=0;
\zf/variable/
	    int variable;</code></pre>
</div>
</div>
<div class="paragraph">
<p>(This works by searching back to the closest previous function definition
using the saved command (<code>\zf</code>) and then searching forward for the
first occurence of the name <code>variable</code> with <code>/variable/</code>.)</p>
</div>
<div class="paragraph">
<p>To print out to the line printer the listing of the
function currently being browsed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>\zf, /^}/ &gt; lpr</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are fancier things, too.
If we want to know which subroutines call <code>proc()</code>,
we can again use <code>\zf</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>g/proc()/\zf
	func1(x)
	func2(y)
	func3()</code></pre>
</div>
</div>
<div class="paragraph">
<p>After using macros like <code>\zf</code> for a while,
they become familiar to the point
that they become idiomatic, a part of the <strong>Qed</strong> language.
To help the user develop a personal working environment,
<strong>Qed</strong> provides
a simple mechanism for initializing.
Typing
(to the Shell)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>$ qed -x qfile file1 file2</code></pre>
</div>
</div>
<div class="paragraph">
<p>causes <strong>Qed</strong> to load the file named <code>qfile</code> into buffer <code>~</code> (<em>tilde</em>)
<strong>and execute it,</strong> before reading in the
files to be edited (<code>file1</code>, <code>file2</code>), and beginning the normal editing session.
Typically, the startup file is used to initialize options
and registers; it might contain something like:</p>
</div>
<div class="listingblock">
<div class="title">qfile listing</div>
<div class="content">
<pre class="highlight"><code>""Qed
zc:s|$|	/* \cl */|p
zf:?^[a-zA-Z_].*(?
b~Z    " destroy buffer after execution</code></pre>
</div>
</div>
<div class="paragraph">
<p>which prints a message (<code>Qed</code>);
defines a couple of handy registers (<code>zc</code> and <code>zf</code>);
and obliterates itself (<code>b~Z</code>).
If no <code>-x</code> option is given when <strong>Qed</strong> is invoked,
<strong>Qed</strong> will try to load the file named by the (Shell) environment variable
<code>QEDFILE</code> into register <code>~</code>, and run that instead. If the variable
<code>QEDFILE</code> is undefined then no startup file is loaded.</p>
</div>
<div class="paragraph">
<p>Browsing through the startup files of a few experienced <strong>Qed</strong> hacks,
a few interesting things come to light.
One simple but rather pretty option was</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>ob""\cx1a"+p</code></pre>
</div>
</div>
<div class="paragraph">
<p>Character <code>\x1A</code> was a <em>reverse line-feed</em> on most of the U. of T. terminals;
The <em>browse option</em> (<code>ob</code>) defines a special register
which is executed, if defined, when a simple newline
is typed at the terminal, rather than doing the default <code>+p</code>
(<em>print next line</em>).
Printing a reverse line-feed before the <code>+p</code> means
that no empty lines appear on the screen when browsing through
text.</p>
</div>
<div class="paragraph">
<p>On a modern terminal the equivalent ANSI escape sequence version
would be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>ob""\x1b[F"+p</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is sometimes useful to set the browse register to
something like <code>+b</code> for easy paging through text,
or to <code>P</code> or <code>L</code>, which cause the line to
be displayed in the format of <code>p</code> or <code>l</code>, but
with line numbers at the beginning of the line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>22i Line	22
p
	Line	22
l
	Line\t22
P
	22	Line	22
L
	22	Line\t22</code></pre>
</div>
</div>
<div class="paragraph">
<p>These other display formats are also sometimes handy in global searches:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>g/proc()/ \zf P
	104	func1(x)
	118	func2(y)
	221	func3()</code></pre>
</div>
</div>
<div class="paragraph">
<p>Another nice register to have tucked away (as it is above) is the C-commenting
command we saw earlier:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>zc:s@$@	/* \cl */@ p</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can call it up when desired:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>p
	bizarre();
\zc(A Kludge)
	bizarre();	/* (A Kludge) */
g/xxxxx/ p \czc
	yyy xxxxx yyy
needles
	yyy xxxxx yyy	/* needles */
	zzz xxxxx zzz
haystacks
	zzz xxxxx zzz	/* haystacks */
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following register definition allows the user to
find a buffer by its file name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>zb:G/\cl/ f\cN
\zbfile
	g'.34	file.c</code></pre>
</div>
</div>
<div class="paragraph">
<p>We don&#8217;t even need to type the suffix <code>.c</code>!</p>
</div>
<div class="paragraph">
<p>Here is a rather complicated, but conceptually simple,
register, <code>\zs</code> (for <em>search</em>), which globally searches
for a pattern in all the buffers from <code>a</code> through <code>z</code>,
and leaves dot at the last occurrence found.
For readability, from here on, we will usually list the contents
of a register with real newlines in place of the <code>\N</code>-s, or the
escaped newlines, and without the delays to special characters, that would
be necessary when actually assigning the program to a register. Compare what
you would have to type at the keyboard to assign this program to
register <code>s</code>, with the listing that follows!</p>
</div>
<div class="listingblock">
<div class="title">writing to zs at the terminal (with escaped newlines)</div>
<div class="content">
<pre class="highlight"><code>zs:zB:\cB\
zP:\cl\
zI:`\
h26 zI+1 b\cczI $zD#a=0 yt g/\czP/ ""\ccB:" P zB:\ccB\
b\czB</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or worse (this is all on <strong>one</strong> line!):</p>
</div>
<div class="listingblock">
<div class="title">writing to zs at the terminal (with delayed newlines)</div>
<div class="content">
<pre class="highlight"><code>zs:zB:\cB\cN zP:\cl\cN zI:`\cN h26 zI+1 b\cczI $zD#a=0 yt g/\czP/ ""\ccB:" P zB:\ccB\cN b\czB</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Versus</em> a comparatively sane listing:</p>
</div>
<div class="listingblock">
<div class="title">zs program listing</div>
<div class="content">
<pre class="highlight"><code>zB:\B
zP:\l
zI:`
h26 zI+1 b\czI $zD#a=0 yt g/\zP/ ""\cB:" P zB:\cB
b\zB</code></pre>
</div>
</div>
<div class="paragraph">
<p>But what does all this mean !?
One step at a time:</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">zs program walk-through</div>
<div class="ulist">
<ul>
<li>
<p><code><strong>zB:\B</strong></code> sets register <code>B</code> to the current buffer name;</p>
</li>
<li>
<p><code><strong>zP:\l</strong></code> sets register <code>P</code> to the rest of the commandline (<em>i.e.</em>
the user-supplied pattern; if there were special characters
in the pattern, we would probably have to delay them once
more than usual to achieve the desired result.)</p>
</li>
<li>
<p><code><strong>zI:`</strong></code> sets register <code>I</code>, a counter, to the character immediately
prior to <code>a</code> in Unicode.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The next line does all the work, and reads something like:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code><strong>h26</strong></code> <em>for</em> 26 iterations <em>do</em></p>
<div class="ulist">
<ul>
<li>
<p><code><strong>zI+1</strong></code> increment I (iterates over the alphabet)</p>
</li>
<li>
<p><code><strong>b\czI</strong></code> switch to (new) buffer \zI</p>
</li>
<li>
<p><code><strong>$zD#a</strong></code> set D to the address of the last line of the buffer</p>
</li>
<li>
<p><code><strong>=0</strong></code> test for D = 0 ?</p>
</li>
<li>
<p><code><strong>yt</strong></code> <em>if</em> (D=0) is true <em>then</em> skip the rest of the line, resuming the next iteration</p>
</li>
<li>
<p><code><strong>g/\zP/</strong></code> <em>else</em> <em>for</em> every line matching the given pattern \zP <em>do</em></p>
<div class="ulist">
<ul>
<li>
<p><code><strong>""\cB:"</strong></code> print the current buffer name and a colon</p>
</li>
<li>
<p><code><strong>P</strong></code> print the matched line, with line number</p>
</li>
<li>
<p><code><strong>zB:\cB</strong></code> set register B to the current buffer name</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Finally, the last command</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code><strong>b\zB</strong></code> switch to buffer name in register <code>B</code>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>After execution, <code>zB</code> contains the last buffer name in which a match
was found, and <strong>Qed</strong> automatically
keeps track of the line number on which the match was found.
The last line of <code>zs</code> therefore changes back to
buffer <code>\zB</code>, which leaves <em>dot</em> at the last
line printed, similar to the behaviour of <code>g/xxx/p</code>.</p>
</div>
<div class="paragraph">
<p>Got that?</p>
</div>
<div class="paragraph">
<p>Make sure you understand how the <code>s</code> register operates,
as it utilizes many of the standard <strong>Qed</strong> programming techniques,
such as nesting a <em>global</em> inside a <em>huntil</em>.</p>
</div>
<div class="paragraph">
<p>Well, that was instructive, but rather revolting.
If you understood how the search register works,
you&#8217;re doing very well, but it&#8217;s not a good example of
how to program <strong>Qed</strong>, just a pedagogical one.
Here&#8217;s how to <em>really</em> do it:</p>
</div>
<div class="listingblock">
<div class="title">globuf search program listing</div>
<div class="content">
<pre class="highlight"><code>G/^[a-z]/ g/\l/ ""\cB:" P</code></pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Exercise</div>
<div class="paragraph">
<p>Modify this version so that it remembers the last buffer
in which a match was found.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>You&#8217;ll find as you gain experience that <em>huntil</em>-s are rarely used,
but they do have their moments.</p>
</div>
<div class="paragraph">
<p>Using the register is quite easy;
just type <code>\zs</code> followed by the pattern being searched for:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>\zs^func()
	a:86	func()
	b:102	func() {
f
	b .209	junk.c</code></pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Exercise</div>
<div class="paragraph">
<p>Set up your startup buffer to include
the original definition of <code>zs</code>
using delayed <code>\N</code>-s where necessary.
Is a delayed newline necessary at the end of the register?
Why, or why not?
(<strong>Hint:</strong> Where does the newline at the end of the invocation line end up?)
Define a second register like <code>s</code>,
but which executes a definable register, say <code>e</code>, for <em>execute,</em>
rather than just printing the line.
You can use our one-liner version (above) that we stored in register <code>x</code> here.
What useful things might be put in register <code>e</code>?</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Registers can also be used to call the Shell.
Register <code>d</code>, defined below,
calls <code>pwd</code> to
get the current directory, saving the result
in register <code>e</code>,
so that the user can quickly return after changing
working directory.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>zd:ovr zB:\cB\cN bX &lt;pwd \cN ze. d b\czB ovs zep zB:</code></pre>
</div>
</div>
<div class="paragraph">
<p>This definition of register <code>d</code> is also exactly as it would appear
in a startup file.
The <code>ze.</code> command
puts a copy of the current line in register <code>e</code>.
The delayed newlines are necessary; unpacked, the string looks like</p>
</div>
<div class="listingblock">
<div class="title">zd program listing</div>
<div class="content">
<pre class="highlight"><code>ovr zB:\B
bX &lt;pwd
ze. d b\zB ovs zep zB:</code></pre>
</div>
</div>
<div class="paragraph">
<p>Briefly: turn verbose mode off (<code>ovr</code>);
save the current buffer name into register <code>B</code> (<code>zB:\B</code>);
change to buffer <code>X</code> (<code>bX</code>) and get the directory (<code>&lt;pwd</code>);
save it in register <code>e</code> (<code>ze.</code>);
delete the line from the buffer (<code>d</code>);
change back to the original buffer (<code>b\zB</code>);
turn verbose mode back on (<code>ovs</code>);
print the saved directory (<code>zep</code>);
and clear register <code>B</code> (<code>zB:</code>).</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="_programming_2">10. Programming (2)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>So far, the emphasis has been on using registers as programming elements,
primarily because the size and complexity of the problems
being handled has been small enough that registers are really
the way to deal with them.
Ultimately, though,
more complicated problems arise and it becomes necessary to store
command sequences in buffers.
In light of that, one more register definition, <code>r</code> for <em>run,</em>
will make using program buffers somewhat simpler.
Called as</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>\zrbuffer</code></pre>
</div>
</div>
<div class="paragraph">
<p>it reads file <code>buffer.q</code>, prepended by the search path
stored in register <code>q</code>, into a scratch buffer, executes it,
and then clears the scratch buffer.
Typically, register <code>q</code> would be set by the startup buffer to contain
something like <code>/home/rob/q/</code>
so</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>\zrcommand</code></pre>
</div>
</div>
<div class="paragraph">
<p>runs the buffer in the file <code>/home/rob/q/command.q</code>.
Register <code>r</code> is long, but linear, having no loops.
As an unpacked listing, with newlines, it looks like:</p>
</div>
<div class="listingblock">
<div class="title">zr program listing</div>
<div class="content">
<pre class="highlight"><code>zL#r
z{:\l
z|:\B
ovr b{
e \zq\z{.q
ovs b\z| \b{
b{ Z
b\z|</code></pre>
</div>
</div>
<div class="paragraph">
<p>This looks considerably more bizarre than our earlier definitions,
because it follows some conventions that have proven useful.
The registers and buffers with funny names (<code>{</code>, <code>|</code>, <code>}</code>, and <code>~</code>)
are (unofficially) reserved as scratch areas: anything you put
in one is not guaranteed to stay there
if you call in an external buffer.
<code>zr</code> uses registers <code>{</code> and <code>|</code> to hold
the program name typed by the user and the buffer the register
was called from, and buffer <code>{</code> to hold the program.
<strong>Qed</strong> itself uses register <code>~</code> to hold the initialization code
to bootstrap the startup buffer,
but clears it before going to the terminal for input.
(A side effect of this is that your startup buffer can
zap <code>z~</code> to alter the bootstrap procedure.)</p>
</div>
<div class="paragraph">
<p>Other conventions are that upper case registers and buffers
are reserved for use by program buffers, such as the ones
we will be developing in this section; and lower case letters
are reserved for the user.</p>
</div>
<div class="paragraph">
<p><code>zr</code> stores in registers <code>L</code> and <code>M</code> the addressed
lines for the buffer being called
(via the <em>range</em> operator: <code>zL#r</code>).
Following these conventions means that a user can call a copy of someone
else&#8217;s program buffer, for example, without worrying about
which registers and buffers it uses.</p>
</div>
<div class="paragraph">
<p>The <code>ovr</code> and <code>ovs</code> calls in register <code>r</code> set the <em>verbose flag</em>
off and on when appropriate, to suppress the occasional
character counts on i/o.
The register as defined here actually works, but what we really want
is something a bit spiffier, so, let&#8217;s have <code>\zr</code> load a
particular buffer file, which we will describe immediately afterwards:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>zr:zL#r z}:\cB\cN ovr b~e \czqrun\cN \cb~\cN b\cz}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This loads buffer <code>~</code> with the file (say) <code>/home/rob/q/run.q</code>.
The buffer is then executed, and the user is returned to
the original buffer.
The <code>run.q</code> buffer file contains:</p>
</div>
<div class="listingblock">
<div class="title">run.q program listing</div>
<div class="content">
<pre class="highlight"><code>" Run a qed buffer `off line'
z{:\l
z{C
" the next line puts a space at the end of the register
z{$
" the next line looks for a space in the argument string
z|'{  z{[
z~#c  z{)\z~  z|(\z~  z|C
" z{: command   z|: argument string   z}: return buffer set by zr
b{ e \zq\z{.q
ovs
b\z} \b{
" Note! ok to ZERO buffer ~ (this buffer); the line will finish executing
b{Z b~Z</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>zXC</code> command is kludgey but handy:
it collapses multiple blanks and tabs in the register to single blanks,
and deletes leading blanks.
The first few lines of the buffer put the command and its arguments
(if present)
into registers <code>{</code> and <code>|</code>.
The new register commands introduced here are:</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">register commands</div>
<div class="ulist">
<ul>
<li>
<p><code><strong>zx[string</strong></code> stores in the <em>count</em> the starting
index of <code>string</code> in register <code>x</code></p>
</li>
<li>
<p><code><strong>zy#c</strong></code> saves the <em>count</em> in register <code>y</code></p>
</li>
<li>
<p><code><strong>zx)N</strong></code> <em>takes</em> the first <code>N</code> characters from the register, and
discards the remainder</p>
</li>
<li>
<p><code><strong>zx(N</strong></code> <em>drops</em> the first <code>N</code> characters from the register, and
preserves the remainder</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Although it&#8217;s a little unfair to show these commands
to you this late in the
game, they didn&#8217;t really need showing earlier on, and they are
quite simple to master.
The <em>count</em> also hasn&#8217;t shown up before,
so we&#8217;d best explain it now.
It is a special place, something like the <em>truth,</em>
which gets set to the number of characters transferred
during i/o operations; the number of substitions made during
an <code>s</code> command; and to other such numbers, as above.
Although rarely used, it, too, has its moments.</p>
</div>
<div class="paragraph">
<p>The requested buffer is then loaded into buffer <code>}</code> and executed.
Finally, the loaded buffer and buffer <code>~</code> are zeroed,
and <code>run.q</code> returns.</p>
</div>
<div class="paragraph">
<p>Although its coding is not particularly pretty,
the power register <code>r</code> gives us is dramatic.
It is really part of the <strong>Qed</strong> language,
since it allows the user to store
many command buffers in the file
system, but get at them easily and in a mnemonic fashion.
It itself employs two conventions which are therefore ubiquitous:
registers <code>L</code> and <code>M</code> hold the lines being addressed by a buffer call,
and buffers <code>{</code> and <code>~</code> are off-limits to command buffers.
The latter point, of course, shows the weakness of a language
in which all the variables are global,
but let&#8217;s ignore that theoretical issue for the moment:
<strong>Qed</strong> has many other weaknesses which are far more important!</p>
</div>
<div class="paragraph">
<p><code>zr</code> is only useful if we have some buffers to drive with it.
For starters, we can take our <code>search</code> register and put it in
a buffer (say <code>/home/rob/q/grep.q</code>):</p>
</div>
<div class="listingblock">
<div class="title">grep.q file listing</div>
<div class="content">
<pre class="highlight"><code>" Grep for z| (possibly set by caller) in all buffers
z|=
yf'fi
	""pattern:" z|:\l
"fi
G/^[a-zA-Z]/ g/\z|/ ""\cB:" P</code></pre>
</div>
</div>
<div class="paragraph">
<p>A few noteworthy points occur:
firstly, we can prompt the user for missing arguments.
If the user types</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>\zr grep expr</code></pre>
</div>
</div>
<div class="paragraph">
<p>(notice the blanks, which are deleted by the <code>run</code> buffer)
we can search for <code>expr</code> directly; but if no expression is
specified, we just ask for it.</p>
</div>
<div class="paragraph">
<p>Secondly, putting the code into a buffer means
everything can be delayed one less time, which makes it more
readable,
and the initialization and cleanup code is shared by all command buffers,
providing a clean and uniform interface.
Also, after execution, register <code>r</code> returns the user to the
buffer they started in, rather than leaving them in some random place.
For this example, it may or may not matter, but in some
cases it is advantageous to return &#8216;home&#8217;.</p>
</div>
<div class="paragraph">
<p>Here is a new example.  It right justifies the addressed lines,
something of mild utility, but too special purpose to keep around
as a real program.
It only takes a couple of minutes, though, to write a <strong>Qed</strong> buffer
to do it, which can then be saved away:</p>
</div>
<div class="listingblock">
<div class="title">rjust.q program listing</div>
<div class="content">
<pre class="highlight"><code>" Right justify addressed lines (default to (1,$))
zL#=\zM yf'fi
	1,$zL#r
"fi
" The white space below is a space and a tab
\zL,\zMs/^[ 	]*//
\zL,\zMs/[ 	]*$//
zW:0
\zL,\zM g/^/ zC#l#&lt;\czW yt zW:\czC
zW#&gt;35 yf zW:35
zD:	                   |
zD)\zW
\zL,\zM s/^/\zD/
" Turn spaces into periods
zD+14
\zL,\zM s/^ ,\(\zD\)$/\1/
zD-14
\zL,\zM s/^\zD//
zL:\N zM:\N zC:\N zD:\N zW:</code></pre>
</div>
</div>
<div class="paragraph">
<p>(Another new command (sorry!): <code>zC#l</code> sets register <code>C</code>
to the length of the current line.)</p>
</div>
<div class="paragraph">
<p>This buffer illustrates how command buffers use the <code>(zL,zM)</code>
address pair.
Clearing the registers afterwards is a good practice for program buffers
to follow.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Exercise</div>
<div class="paragraph">
<p>Why is there no <code>\N</code> on the end of the last line?</p>
</div>
</div>
</div>
<div class="paragraph">
<p>To invoke this program on a suitable buffer full of, say, words
one to a line, we save it away in
<code>/home/rob/q/right.q</code> and type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>ba	" where the data is
,p
	excle
	ficatings
	criminter
	con
	explasence
	des
	ofh
	fultesibe
	shispensitment
	dedgearing
	expers
" yes, they're random words
\zrright
,p
	         excle
	     ficatings
	     criminter
	           con
	    explasence
	           des
	           ofh
	     fultesibe
	shispensitment
	    dedgearing
	        expers</code></pre>
</div>
</div>
<div class="paragraph">
<p>As the <em>Ronco</em> man would say, &#8220;Isn&#8217;t that amazing!&#8221;</p>
</div>
<div class="paragraph">
<p>Can we do anything useful with all this power?
Well, we can write a buffer <code>un</code> (for <em>run</em> or <em>unix</em>)
which pipes the addressed lines out to
a shell command line, and replaces them in the buffer
with the output of the command. This functionality is now largely provided
by the <em>pipe</em> command (<code>|</code>), but creating an implementation of <em>pipe</em>
in pure <strong>Qed</strong>, is itself instructive:</p>
</div>
<div class="listingblock">
<div class="title">un.q program listing</div>
<div class="content">
<pre class="highlight"><code>" un.q -- replace addressed lines of current buffer by result
"	  of passing them through pipeline
"	  Looks in z| for pipeline; if empty, prompts &amp; reads from terminal
"	  Called as addr1, addr2 \zrun; defaults to (1,$).
z|=
yf'fi
	""&lt;&gt; "
	z|:\l
"fi
zL#=\zM yf 1,$zL#r
ovr
\zL,\zM &gt; \z| &gt; /tmp/qed
zT#t	" zT gets return status from truth
\zMr /tmp/qed
!rm /tmp/qed
ovs
zT#=0 yf'else
	""Invalid status return - lines not deleted
	y'fi
"else
	\zL,\zMd
"fi
zL:\NzM:\NzT:
""!\N</code></pre>
</div>
</div>
<div class="paragraph">
<p>The prompt is reminiscent of <em>crunch-zap</em>.
The <code>yf&#8217;else</code> tests the return status of the
command, and decides not to delete the original lines
if the status was bad (<em>i.e.</em> non-zero).
Using the <code>\zrun</code> (<em>run buffer</em> <code>un.q</code>) combination,
we can process the data in a buffer
through any arbitrary pipeline, such as</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>,p
	excle
	ficatings
	criminter
	con
	explasence
	des
	ofh
	fultesibe
	shispensitment
	dedgearing
	expers
\zrun sort
	!
,p
	con
	criminter
	dedgearing
	des
	excle
	expers
	explasence
	ficatings
	fultesibe
	ofh
	shispensitment</code></pre>
</div>
</div>
<div class="paragraph">
<p>To send out only a portion of the buffer to the pipeline,
the usual convention is used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>.,/ful/ \zrun sort</code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="_final_comments">11. Final Comments</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Qed</strong> is a large system,
but its concepts are, for the most part,
simple extensions from those of <strong>Ed</strong>.
Although it provides no new functionality in <strong>UNIX</strong>,
it can greatly simplify many text-manipulation
tasks,
ranging from day-to-day editing problems to production-level
text processing.
By striking a harmonious balance between
<strong>Qed</strong> and <strong>UNIX</strong>'s other tools,
the intelligent user will find <strong>Qed</strong>
powerful, flexible, easy to master, and fun!</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="_editors_notes">12. Editor&#8217;s Notes</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_remarks">12.1. Remarks</h3>
<div class="paragraph">
<p>The Tutorial really does assume fluency in <strong>Ed</strong>. An
updated Tutorial for a modern audience should certainly begin
with an introduction to the line-oriented editing
paradigm, and the basic <strong>Ed</strong>-like functionality in <strong>Qed</strong>.</p>
</div>
<div class="paragraph">
<p>Some of the original examples are pretty anachronistic, and would
have seemed less exotic to someone sitting at a U. of T. terminal
back in the early '80s. An updated Tutorial should choose
examples which would seem familiar to today&#8217;s audience. Perhaps
some programs for doing common <code>git</code> tasks.</p>
</div>
<div class="paragraph">
<p>The section on Registers needed a major overhaul, as the mini-languages
used in register and numeric-register operations had changed significantly.</p>
</div>
<div class="paragraph">
<p>There were surprisingly few typos in the original, quite a feat
considering that many of the examples had <strong>Qed</strong> code interspersed
with <em>troff</em> code!</p>
</div>
</div>
<div class="sect2">
<h3 id="_history">12.2. History</h3>
<div class="paragraph">
<p>Originally written by <strong>Robert Pike</strong> at U. of T. in 1992..</p>
</div>
<div class="paragraph">
<p>Converted to <code>asciidoc</code>, edited,
and updated by <em>Sean Jensen</em> in February 2021.</p>
</div>
</div>
<div class="sect2">
<h3 id="_resources">12.3. Resources</h3>
<div class="paragraph">
<p>Rob Pike&#8217;s original U. of T. Qed tarball:
<a href="https://github.com/arnoldrobbins/qed-archive/unix-1992" class="bare">https://github.com/arnoldrobbins/qed-archive/unix-1992</a></p>
</div>
<div class="paragraph">
<p>Sean Jensen&#8217;s port of Qed, including this tutorial:
<a href="https://github.com/phonologus/QED" class="bare">https://github.com/phonologus/QED</a></p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2021-02-20 12:49:35 UTC
</div>
</div>
</body>
</html>